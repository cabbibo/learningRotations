<html>
<body>
  <head>
    <style>
      #container{

        
   width      : 100%;
   height     : 100%;
   position   : absolute;
   top        : 0px;
   left       : 0px;
   background : #000;

      }
    </style>
  </head>
<script src = "jquery.min.js"         ></script>
<script src = "leap.js"               ></script>
<script src = "three.js"              ></script>
<script src = "stats.min.js"          ></script>
<script src = "TrackballControls.js"  ></script>
<script src = "FlyControls.js"        ></script>
<script src = "Fish.js"               ></script>
<script src = "fishSkeleton.js"       ></script>
<script src = "place.js"              ></script>
<script src = "DragonFish.js"         ></script>
<script src = "AudioController.js"    ></script>
<script src = "AudioTexture.js"       ></script>
<script src = "UserAudio.js"          ></script>
<script src = "Stream.js"             ></script>
<script src = "underscore.js"         ></script>
<script src = "ShaderLoader.js"       ></script>
<script src = "Hook.js"       ></script>

<script>  

  var container , camera, scene, renderer , stats;

  var clock;
  
  var sceneSize = 10;

  var fish;

  var fishes = [];

  var tmpMat;

  var jellyMat;

  var lights = [];
  var mouse;
  var counter = 0;

  var time = { type:"f" , value:0 }

  var intersectPlane;
  var projector , raycaster;
  var paused = false;

  var distanceToIntersectPlane = 10;

  var audioController = new AudioController();
  audioController.mute.gain.value = 0.0;


  var shaders = new ShaderLoader('shaders');

  shaders.load( 'fs-floor'    , 'floor'   , 'fragment'    );
  shaders.load( 'vs-floor'    , 'floor'   , 'vertex'      );
  shaders.load( 'fs-sphere'    , 'sphere'   , 'fragment'    );
  shaders.load( 'vs-sphere'    , 'sphere'   , 'vertex'      );

  shaders.shaderSetLoaded = function(){
    //init();
    //animate();
    //stream.play();
    //onStart();
  }

  var userAudio = new UserAudio( audioController );


  var stream = new Stream( 'magicStick.mp3' , audioController );

  userAudio.onStreamCreated = function(){
    console.log( 'asss');
    onStart();

  }
  
  function onStart(){
    console.log('hello');
    
    init();

    var u = {
      uPos: { type:"v3" , value : dragonFish.leader.position },
      uVel: { type:"v3" , value : dragonFish.leader.velocity },
      t_audio:{ type:"t" , value: audioController.texture },
      audioLookup:{ type:"f", value: .2},
      time:time
    }

    jellyMat = new THREE.ShaderMaterial({

      uniforms: u,
      vertexShader:shaders.vertexShaders.sphere,
      fragmentShader:shaders.fragmentShaders.sphere,
      side:THREE.DoubleSide,
      blending:THREE.AdditiveBlending,
      transparent:true,
      depthWrite:false,
    });

    var beak1 = new THREE.Mesh( 
      new THREE.CylinderGeometry( 1.3 , 1.3 , 2.3, 500 ,50,50 ),
      jellyMat
    );

    beak1.rotation.x = -Math.PI / 2;
    beak1.position.z = 1.3;

    dragonFish.leader.body.add( beak1 );

    var geo =  new THREE.CylinderGeometry( 1.45 , 0 , 1.6, 100 ,50,1 );

    for( var i = 0; i < dragonFish.spine.length; i++ ){


      var b = new THREE.Mesh( 
      geo,
      jellyMat
      );

      b.rotation.x = -Math.PI / 2;
      b.position.z = .2;
      
      dragonFish.spine[i].body.add( b );

    }


    for( var i = 0; i < 40; i++ ){

      var mesh = new THREE.Mesh( geo , jellyMat );
      mesh.rotation.x = - Math.PI / 2;
      var obj = new THREE.Object3D();
      obj.add( mesh );
      hook = new Hook( obj );

      scene.add( obj );

    }
    
  
    animate();

  }



  function init(){

    
    controller = new Leap.Controller();

    tmpMat = new THREE.Matrix4();
    
    scene = new THREE.Scene();
    
    camera = new THREE.PerspectiveCamera( 
      50 ,
      window.innerWidth / window.innerHeight,
      sceneSize / 100 ,
      sceneSize * 400
      );

    // placing our camera position so it can see everything
    camera.position.z = sceneSize ;

    clock = new THREE.Clock();

    //controls = new THREE.TrackballControls( camera );

    controls = new THREE.FlyControls( camera );

    controls.movementSpeed = 4;
    controls.rollSpeed = Math.PI / 5 ;
    controls.autoForward = false;

    controls.dragToLook = false;


    var geo = new THREE.IcosahedronGeometry( 10 , 0 )
    var geo = new THREE.CubeGeometry( 10 , 1 , 1 )
    var mat = new THREE.MeshBasicMaterial();

    var geometry = new THREE.Geometry();

    place(0,0,0,0);
    place(0,0,0,1);
    place(0,0,0,2);
    place(0,0,0,3);
    place(0,0,0,4);
    place(0,0,0,5);
    place(10,0,0,0);
    place(-10,0,0,1);
    place(0,10,0,2);
    place(0,-10,0,3);
    place(0,0,10,4);
    place(0,0,-10,5);
    place(10,10,0,0);
    place(-10,10,0,1);
    place(-10,10,0,2);
    place(-10,-10,0,3);
    place(10,0,10,4);
    place(10,0,-10,5);


    var geo = new THREE.IcosahedronGeometry(10 ,0 );

    for( var i=0; i < placingMatrix.length; i++ ){

      var mesh = new THREE.Mesh( geo , mat );

      var p = placingMatrix[i][0];
      var s = placingMatrix[i][1];
      var r = placingMatrix[i][2];

      mesh.position.set( p[0] , p[1] , p[2] );
      mesh.scale.set( s[0] , s[1] , s[2] );
      mesh.rotation.x = r[0]//,r[1],r[2] );
      mesh.rotation.y = r[1]//,r[1],r[2] );
      mesh.rotation.z = r[2]//,r[1],r[2] );

      mesh.updateMatrix();
      geometry.merge( geo , mesh.matrix );

    }

    var mat = new THREE.MeshLambertMaterial({
      shading: THREE.FlatShading,
      color:0xffffff,
      map:audioController.texture,
      wireframe:true
    });

    stones = new THREE.Mesh( geometry , mat );
    scene.add( stones );



    var geo = new THREE.IcosahedronGeometry( 300 , 3 );
    var mat = new THREE.MeshLambertMaterial({ 
      wireframe:true,
      map:audioController.texture,

    
    });

    skyBox = new THREE.Mesh( geo , mat );
    scene.add( skyBox );


    console.log( placingMatrix );
        
    mouse = new THREE.Vector2();
    // Getting the container in the right location
    container = document.createElement( 'div' );
    container.id = "container";
    
    document.body.appendChild( container );


    // Getting the stats in the right position
    stats = new Stats();

    stats.domElement.style.position  = 'absolute';
    stats.domElement.style.bottom    = '0px';
    stats.domElement.style.right     = '0px';
    stats.domElement.style.zIndex    = '999';

    document.body.appendChild( stats.domElement );

    // Setting up our Renderer
    renderer = new THREE.WebGLRenderer();

    renderer.setSize( window.innerWidth, window.innerHeight );
    container.appendChild( renderer.domElement );

    // Making sure our renderer is always the right size
    window.addEventListener( 'resize', onWindowResize , false );

    window.addEventListener( 'mousemove' , onMouseMove , false );


    projector = new THREE.Projector();
    raycaster = new THREE.Raycaster();
    
    createLightCluster(  0xffaa00 , new THREE.Vector3( 0 , 0 , 1 ) );
    createLightCluster(  0xaa00ff , new THREE.Vector3( 0 , 1 , 0 ) );
    createLightCluster(  0x00ffaa , new THREE.Vector3( 1 , 0 , 0 ) );
    createLightCluster(  0xffaa00 , new THREE.Vector3( 0 , 0 , -1 ) );
    createLightCluster(  0xaa00ff , new THREE.Vector3( 0 , -1 , 0 ) );
    createLightCluster(  0x00ffaa , new THREE.Vector3( -1 , 0 , 0 ) );
    

    // Object our dragon fish follows
    bait = new THREE.Object3D();

    dragonFish = new DragonFish( bait );

    //dragonFish1 = new DragonFish( dragonFish.leader);
    //dragonFish2 = new DragonFish( dragonFish1.leader);

    // Hooks

    var geo = new THREE.CylinderGeometry( .5 , 0, .9 );
    var mat = new THREE.MeshBasicMaterial({
     // shading: THREE.FlatShading,
      color:0xffaaaa,
      map:audioController.texture,
    });

   // var mesh = new THREE.Mesh



    /*for( var i = 0; i < 20; i++ ){

      var mesh = new THREE.Mesh( geo , mat );
      mesh.rotation.x = - Math.PI / 2;
      var obj = new THREE.Object3D();
      obj.add( mesh );
      hook = new Hook( obj );

      scene.add( obj );

    }*/
    

    // Plane for mouse
    intersectPlane = new THREE.Mesh(
      new THREE.PlaneGeometry( 30 , 30 ),
      new THREE.MeshNormalMaterial()
    );

    intersectPlane.visible = false;
    scene.add( intersectPlane );

   
    var mesh = new THREE.Mesh(
      new THREE.IcosahedronGeometry( .2 , 1 ),
      new THREE.MeshBasicMaterial()
    );

    bait.add( mesh );

    document.addEventListener( 'keydown' , function(e){

        if( e.which == 32 ){

          paused = !paused;

        }

         if( e.which == 65 ){

           dragonFish.addVertabrae();

         }

          if( e.which == 81 ){

           console.log( dragonFish.spine[5] );

         }

      


    });


   // controller.connect();

  }

   function animate(){

     counter += 1;

        audioController.update();
     
     var delta = clock.getDelta();
     controls.update(delta);

    time.value += delta;
    stats.update();


    for( var i = 0; i < hooks.length; i++ ){

      //hooks[i].mesh.position.x = Math.cos( time.value * ( i +5) / 13) * (i+20) / 20;
      //hooks[i].mesh.position.y = Math.sin( time.value * (i+6) / 10) * (i+20) / 20;
      //hooks[i].mesh.position.z = Math.cos( time.value * (i+7) / 12 ) * (i+20)/ 20;
     

      var a = audioController.analyzer.array[i*5] /2;
      var sub =  hooks[i].vertabrae.sub;
      for( var j=0; j < sub.length; j++ ){

        sub.sibRepelDist =1+ a*a;
        sub.sibRepelDiv = 30- a*a*2;

      }
      
      hooks[i].update();


      var dif = hooks[i].mesh.position.clone().sub( dragonFish.leader.position );

      if( dif.length() <= 2 ){

        dragonFish.addPrecreatedVertabrae( hooks[i].vertabrae );

       hooks.splice( i , 1 );
        i--;
        console.log( dif.length() );

      }
    }

    for( var i = 0; i < hooks.length; i++ ){
      hooks[i].update2();
    }

    for( var i = 0; i < dragonFish.spine.length; i++ ){


      var spine = dragonFish.spine[i];
      var a = audioController.analyzer.array[i*5] /256;
      var vel = spine.velocity;

      for( var j=0; j < spine.sub.length; j++ ){

        var sp = spine.sub[j];
        sp.sibRepelDist =1+ a*a;
        sp.sibRepelDiv =30- a*a*2;

      }


    }

    tetraCluster.needsUpdate = true;
    
    
    if( !paused ){

      var frame = controller.frame();

      if( frame.hands[0] ){

        leapToScene( frame, frame.hands[0].palmPosition , bait.position , sceneSize  );

      }else{


        intersectPlane.position.copy( camera.position );
        //console.log( controls.speed );

        var dT = distanceToIntersectPlane;
        var d = dT + ( controls.speed / controls.maxSpeed ) * dT
        var vector = new THREE.Vector3( 0, 0, -d );
        vector.applyQuaternion( camera.quaternion );
        intersectPlane.position.add( vector );

        intersectPlane.lookAt( camera.position );
         var vector = new THREE.Vector3( mouse.x, mouse.y, 1 );
        projector.unprojectVector( vector, camera );

        raycaster.set( camera.position, vector.sub( camera.position ).normalize() );

        var intersects = raycaster.intersectObject( intersectPlane );

        if( intersects.length > 0 ){
         bait.position.copy( intersects[0].point );
        }




      }

      dragonFish.update();




      //dragonFish1.update();
      //dragonFish2.update();


      //camera.position.copy( leader.position );

      //camera.position.y = 5;

      //camera.lookAt( leader.position );
    }


    /*for( var i = 0; i < fishes.length ; i++ ){


      fishes[i].update();

    }*/


     renderer.render( scene , camera );
     requestAnimationFrame( animate );

  }


  // Resets the renderer to be the proper size
  function onWindowResize(){

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );

  }

  function onMouseMove( event ) {

      event.preventDefault();

      mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
      mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

  }

  function leapToScene( frame , leapPos , ourPos , size ){

    var p = frame.interactionBox.normalizePoint( leapPos );

    p[0] -= .5;
    p[1] -= .5;
    p[2] -= .5;

    p[0] *= size;
    p[1] *= size;
    p[2] *= size;

    p[2] -= 2*size; //move away a bit TODO: neccesary?

    var pos = new THREE.Vector3().fromArray( p );
    pos.applyMatrix4( camera.matrix );

    ourPos.copy( pos );


  }


  function createLightCluster(  baseColor , baseDir ){


    var mainColor = new THREE.Color( baseColor );
    var mainDir = baseDir.clone();

    var c = mainColor.clone();
    c.r = c.r + ( (Math.random() -.5) );
    c.g = c.g + ( (Math.random() -.5));
    c.b = c.b + ( (Math.random() -.5) );

    var d = mainDir.clone();
    d.x = d.x + ( (Math.random()-.5) * .5 );
    d.y = d.y + ( (Math.random()-.5) * .5 );
    d.z = d.z + ( (Math.random()-.5) * .5 );

    d.normalize();
    //c.normalize();

   // c.r = d.x;
    var light = new THREE.DirectionalLight(c.getHex() , .6 );
    
    light.position.copy( d );


    lights.push( light );
    scene.add( light );


  }


</script>


</body>
</html>


